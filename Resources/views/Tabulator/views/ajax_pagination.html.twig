{% set dataUrl = gridBlock.getDataUrl() %}
{% set fields = gridBlock.getFields() %}
{% set fieldNames = gridBlock.getFieldsNames() %}
{% set initialPageSize = app.request.query.get('pageSize', 10)|default(10) %}
{% if initialPageSize not in [10, 25, 50, 100] %}{% set initialPageSize = 10 %}{% endif %}
<div class="container-fluid">
    <h1>Product Grid - AJAX Pagination (Tabulator)</h1>
    {% include '@GenakerDataGrid/_filters.html.twig' with {gridBlock: gridBlock} %}
    {% include '@GenakerDataGrid/_page_size_selector.html.twig' %}
    <div id="product-grid"></div>
</div>
<link rel="stylesheet" href="{{ asset('bundles/genakerdatagrid/css/tabulator.min.css') }}">
<link rel="stylesheet" href="{{ asset('bundles/genakerdatagrid/css/preloader.css') }}">
<script src="{{ asset('bundles/genakerdatagrid/js/grid-url-sync.js') }}"></script>
<script src="{{ asset('bundles/genakerdatagrid/js/grid-pagination.js') }}"></script>
<script src="{{ asset('bundles/genakerdatagrid/js/tabulator.min.js') }}"></script>
<script>
(function() {
    var params = GridUrlSync.getParams();
    var currentPage = parseInt(params.get('p') || params.get('page') || '1', 10);
    var currentPageSize = parseInt(params.get('pageSize') || params.get('size') || '10', 10);
    var pageSizeOptions = [10, 25, 50, 100];
    if (pageSizeOptions.indexOf(currentPageSize) < 0) currentPageSize = 10;

    var pageSizeSelect = document.getElementById('grid-page-size-select');
    if (pageSizeSelect && pageSizeSelect.value !== String(currentPageSize)) pageSizeSelect.value = currentPageSize;

    var dataUrl = '{{ dataUrl|e('js') }}';
    var columns = [{% for n in fieldNames %}
        {
            title: '{{ (fields[n] ?? n)|e('js') }}',
            field: '{{ n|e('js') }}',
            headerSort: {{ n == 'image' ? 'false' : 'true' }}
            {% if n == 'image' %}, formatter: function(cell) { var url = cell.getValue(); return '<img src="' + (url || '{{ asset('bundles/genakerdatagrid/images/placeholder.svg')|e('js') }}') + '" style="max-width: 100px; max-height: 80px;" alt="' + (url ? 'Product' : 'No image') + '" />'; } {% endif %}
        }{% if not loop.last %}, {% endif %}
    {% endfor %}];

    function loadData() {
        var url = GridUrlSync.buildFetchUrl(dataUrl, { p: currentPage, pageSize: currentPageSize });
        fetch(url).then(function(r) { return r.json(); }).then(function(res) {
            GridPagination.render('grid-pagination', res.total, currentPage, currentPageSize, goToPage, { paginationHtml: res.paginationHtml });
            table.setData(res.data);
        }).catch(function() { table.setData([]); });
    }

    function goToPage(n) {
        currentPage = n;
        GridUrlSync.syncUrl({ p: currentPage, pageSize: currentPageSize });
        loadData();
    }

    var table = new Tabulator('#product-grid', {
        columns: columns,
        layout: "fitColumns",
        pagination: false,
        placeholder: "No Data Available"
    });

    loadData();

    document.getElementById('grid-page-size-select').addEventListener('change', function() {
        currentPageSize = parseInt(this.value, 10);
        currentPage = 1;
        GridUrlSync.syncUrl({ p: currentPage, pageSize: currentPageSize });
        loadData();
    });
})();
</script>
