{% set dataUrl = gridBlock.getDataUrl() %}
{% set gridData = gridBlock.getGridJsonData() %}
{% set fields = gridBlock.getFields() %}
{% set fieldNames = gridBlock.getFieldsNames() %}
{% set initialPageSize = app.request.query.get('pageSize', 10)|default(10) %}
{% if initialPageSize not in [10, 25, 50, 100] %}{% set initialPageSize = 10 %}{% endif %}
{% set colWidthPct = (100 / fieldNames|length)|round(2) %}
<link rel="stylesheet" href="{{ asset('bundles/genakerdatagrid/css/ag-grid.min.css') }}">
<link rel="stylesheet" href="{{ asset('bundles/genakerdatagrid/css/ag-theme-alpine.min.css') }}">
<style>
#product-grid-container .ag-grid-initial-table { width: 100%; table-layout: fixed; border-collapse: collapse; }
#product-grid-container .ag-grid-initial-table th,
#product-grid-container .ag-grid-initial-table td { padding: 4px; border: 1px solid #aaa; overflow: hidden; text-overflow: ellipsis; width: {{ colWidthPct }}%; }
#product-grid-container .ag-grid-initial-table th { background: #e6e6e6; font-weight: 700; }
#product-grid-container .ag-grid-initial-table tr:nth-child(even) { background: #efefef; }
</style>
<div class="container-fluid">
    <h1>Product Grid - HTML (AG Grid)</h1>
    {% include '@GenakerDataGrid/_filters.html.twig' with {gridBlock: gridBlock} %}
    <div id="product-grid-container" class="ag-theme-alpine" style="height: 600px; width: 100%; min-height: 200px;">
        <table class="ag-grid-initial-table" style="width: 100%;">
            <thead>
                <tr>
                    {% for n in fieldNames %}
                    <th>{{ fields[n] ?? n }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in gridData.data %}
                <tr>
                    {% for n in fieldNames %}
                    <td>{% if n == 'image' %}<img src="{{ row[n] ?: asset('bundles/genakerdatagrid/images/placeholder.svg') }}" style="max-width: 100px; max-height: 80px;" alt="{{ row[n] ? 'Product' : 'No image'}}" />{% else %}{{ row[n] ?? '' }}{% endif %}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script src="{{ asset('bundles/genakerdatagrid/js/grid-url-sync.js') }}"></script>
<script src="{{ asset('bundles/genakerdatagrid/js/ag-grid.min.js') }}"></script>
<script>
(function() {
    var params = GridUrlSync.getParams();
    var initialPage = parseInt(params.get('p') || params.get('page') || '1', 10);
    var initialPageSize = parseInt(params.get('pageSize') || params.get('size') || '{{ initialPageSize }}', 10);
    var initialSortField = params.get('sortField') || null;
    var initialSortOrder = (params.get('sortOrder') || 'asc').toLowerCase();
    if (initialSortOrder !== 'asc' && initialSortOrder !== 'desc') initialSortOrder = 'asc';
    var pageSizeOptions = [10, 25, 50, 100];
    if (pageSizeOptions.indexOf(initialPageSize) < 0) initialPageSize = 10;

    var container = document.getElementById('product-grid-container');
    var fieldIds = {{ fieldNames|json_encode|raw }};
    var fields = {{ fields|json_encode|raw }};
    var dataUrl = '{{ dataUrl|e('js') }}';
    var columnDefs = fieldIds.map(function(field) {
        return {
            headerName: fields[field] || field,
            field: field,
            sortable: field !== 'image',
            filter: field !== 'image',
            cellRenderer: field === 'image' ? function(params) {
                var img = document.createElement('img');
                img.src = params.value || '{{ asset('bundles/genakerdatagrid/images/placeholder.svg')|e('js') }}';
                img.style.maxWidth = '100px';
                img.style.maxHeight = '80px';
                img.alt = params.value ? 'Product' : 'No image';
                return img;
            } : null
        };
    });

    var gridApi;
    var paginationChanging = false;
    var firstRequest = true;
    var datasource = {
        getRows: function(params) {
            var startRow = params.startRow ?? params.request?.startRow ?? 0;
            var endRow = params.endRow ?? params.request?.endRow ?? initialPageSize;
            var pageSize = Math.max(1, endRow - startRow);
            var page;
            if (firstRequest) {
                firstRequest = false;
                page = initialPage;
            } else {
                page = Math.floor(startRow / pageSize) + 1;
            }
            var opts = { p: page, pageSize: pageSize };
            var sortModel = params.sortModel || params.request?.sortModel || [];
            if (sortModel.length) {
                opts.sortField = sortModel[0].colId || sortModel[0].field || '';
                opts.sortOrder = sortModel[0].sort === 'asc' ? 'asc' : 'desc';
            } else if (initialSortField) {
                opts.sortField = initialSortField;
                opts.sortOrder = initialSortOrder;
            }
            var url = GridUrlSync.buildFetchUrl(dataUrl, opts);
            fetch(url).then(function(r) { return r.json(); }).then(function(res) {
                var rows = res.data || [];
                var total = typeof res.total === 'number' ? res.total : parseInt(res.total, 10) || 0;
                params.successCallback(rows, total);
            }).catch(function() { params.failCallback(); });
        }
    };

    container.innerHTML = '';
    var gridDiv = document.createElement('div');
    gridDiv.className = 'ag-theme-alpine';
    gridDiv.style.height = '600px';
    gridDiv.style.width = '100%';
    container.appendChild(gridDiv);

    agGrid.createGrid(gridDiv, {
        theme: 'legacy',
        columnDefs: columnDefs,
        rowModelType: 'infinite',
        datasource: datasource,
        cacheBlockSize: initialPageSize,
        maxBlocksInCache: 1,
        rowHeight: 90,
        pagination: true,
        paginationPageSize: initialPageSize,
        paginationPageSizeSelector: pageSizeOptions,
        defaultColDef: { sortable: true, filter: true },
        initialSort: initialSortField ? [{ colId: initialSortField, sort: initialSortOrder }] : undefined,
        onGridReady: function(e) { gridApi = e.api; },
        onFirstDataRendered: function() {
            if (gridApi && initialPage > 1) {
                gridApi.paginationGoToPage(initialPage - 1);
            }
        },
        onPaginationChanged: function(e) {
            if ((e.newPage || e.newPageSize) && gridApi && !paginationChanging) {
                paginationChanging = true;
                var page = gridApi.paginationGetCurrentPage() + 1;
                var pageSize = gridApi.paginationGetPageSize();
                GridUrlSync.syncUrl({ p: page, pageSize: pageSize });
                gridApi.purgeInfiniteCache();
                gridApi.paginationGoToPage(page - 1);
                setTimeout(function() { paginationChanging = false; }, 0);
            }
        }
    });
})();
</script>
