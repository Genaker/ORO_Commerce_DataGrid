{# Limit 1000 can be removed to load all records #}
{% set gridData = gridBlock.getGridJsonDataWithLimit(1000) %}
{% set fields = gridBlock.getFields() %}
{% set fieldNames = gridBlock.getFieldsNames() %}
<link rel="stylesheet" href="{{ asset('bundles/genakerdatagrid/css/gridjs-mermaid.min.css') }}">
{% set initialPageSize = app.request.query.get('pageSize', 10)|default(10) %}
{% if initialPageSize not in [10, 25, 50, 100] %}{% set initialPageSize = 10 %}{% endif %}
<div class="container-fluid">
    <h1>Product Grid - HTML Table (Grid.js) - Client-side</h1>
    {% include '@GenakerDataGrid/_filters.html.twig' with {gridBlock: gridBlock} %}
    {% include '@GenakerDataGrid/_page_size_selector.html.twig' %}
    <div id="product-grid-container"></div>
</div>
<script src="{{ asset('bundles/genakerdatagrid/js/grid-url-sync.js') }}"></script>
<script src="{{ asset('bundles/genakerdatagrid/js/gridjs.min.js') }}"></script>
<script>
(function() {
    var container = document.getElementById('product-grid-container');
    var fieldIds = {{ fieldNames|default([])|json_encode|raw }} || [];
    var rows = {{ gridData.data|default([])|json_encode|raw }} || [];
    var data = (rows || []).map(function(row) {
        if (!row || typeof row !== 'object') return fieldIds.map(function() { return ''; });
        return fieldIds.map(function(id) { return row[id] != null ? row[id] : ''; });
    });
    var columns = [{% for n in fieldNames %}
        {
            name: '{{ (fields[n] ?? n)|e('js') }}',
            {% if n == 'image' %}
            formatter: (cell) => gridjs.html(`<img src="${cell || '{{ asset('bundles/genakerdatagrid/images/placeholder.svg')|e('js') }}'}" style="max-width: 100px; max-height: 80px;" alt="${cell ? 'Product' : 'No image'}" />`),
            sort: false
            {% endif %}
        }{% if not loop.last %}, {% endif %}
    {% endfor %}];
    var grid = new gridjs.Grid({
        columns: columns,
        data: Array.isArray(data) ? data : [],
        sort: true,
        search: { selector: (cell) => cell != null ? String(cell) : '' },
        pagination: { limit: {{ initialPageSize }} }
    });
    grid.render(container);
    document.getElementById('grid-page-size-select').addEventListener('change', function() {
        var limit = parseInt(this.value, 10);
        if (typeof GridUrlSync !== 'undefined') GridUrlSync.syncUrl({ p: 1, pageSize: limit });
        grid.updateConfig({ pagination: { limit: limit, page: 0 } });
    });
})();
</script>
