{% set dataUrl = gridBlock.getDataUrl() %}
{% set fields = gridBlock.getFields() %}
{% set fieldNames = gridBlock.getFieldsNames() %}
<div class="container-fluid">
    <h1>Product Grid - AJAX (Grid.js)</h1>
    {% include '@GenakerDataGrid/GridJs/_filters.html.twig' with {gridBlock: gridBlock} %}
    <div id="product-grid-container"></div>
</div>
<link rel="stylesheet" href="{{ asset('bundles/genakerdatagrid/css/gridjs-mermaid.min.css') }}">
<link rel="stylesheet" href="{{ asset('bundles/genakerdatagrid/css/preloader.css') }}">
<script src="{{ asset('bundles/genakerdatagrid/js/gridjs.min.js') }}"></script>
<script>
(function() {
    var container = document.getElementById('product-grid-container');
    container.innerHTML = '<div class="grid-preloader"><div class="grid-spinner"></div></div>';
    var columns = [{% for n in fieldNames %}
        {
            name: '{{ (fields[n] ?? n)|e('js') }}',
            {% if n == 'image' %}
            formatter: (cell) => cell ? gridjs.html(`<img src="${cell}" style="max-width: 100px; max-height: 80px;" />`) : ''
            {% endif %}
        }{% if not loop.last %}, {% endif %}
    {% endfor %}];
    var fieldIds = {{ fieldNames|json_encode|raw }};
    var grid = new gridjs.Grid({
        columns: columns,
        sort: {
            server: {
                url: (prev, columns) => {
                    if (!columns.length) return prev;
                    const col = columns[0];
                    const dir = col.direction === 1 ? 'asc' : 'desc';
                    const colName = fieldIds[col.index];
                    return `${prev}${prev.includes('?') ? '&' : '?'}sortField=${colName}&sortOrder=${dir}`;
                }
            }
        },
        server: {
            url: '{{ dataUrl|e('js') }}',
            then: function(r) { return { data: r.data, total: r.total }; }
        },
        pagination: { 
            limit: 20, 
            server: { 
                url: (prev, page, limit) => `${prev}${prev.includes('?') ? '&' : '?'}page=${page + 1}&pageSize=${limit}`
            } 
        }
    });
    container.innerHTML = '';
    grid.render(container);
})();
</script>
